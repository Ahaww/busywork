var t=Object.defineProperty,e=(e,i,s)=>((e,i,s)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s)(e,"symbol"!=typeof i?i+"":i,s);!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}(),window.GameGlobal||(window.GameGlobal=window),window.wx||(window.wx={createCanvas:()=>document.getElementById("gameCanvas"),getWindowInfo:()=>({screenWidth:window.innerWidth,screenHeight:window.innerHeight}),getSystemInfoSync:()=>({screenWidth:window.innerWidth,screenHeight:window.innerHeight})}),GameGlobal.canvas=wx.createCanvas(),window.canvas=GameGlobal.canvas;const i=wx.getWindowInfo?wx.getWindowInfo():wx.getSystemInfoSync();canvas.width=i.screenWidth,canvas.height=i.screenHeight;const s=i.screenWidth,n=i.screenHeight;class o{constructor(){this.e={}}on(t,e,i){return(this.e[t]||(this.e[t]=[])).push({fn:e,ctx:i}),this}once(t,e,i){const s=this;function n(){s.off(t,n),e.apply(i,arguments)}return n._=e,this.on(t,n,i)}emit(t,...e){const i=(this.e[t]||[]).slice();for(let s=0;s<i.length;s++)i[s].fn.apply(i[s].ctx,e);return this}off(t,e){const i=this.e[t]||[],s=[];for(let n=0;n<i.length;n++)i[n].fn!==e&&i[n].fn._!==e&&s.push(i[n]);return s.length?this.e[t]=s:delete this.e[t],this}}const r=new class{constructor(){this.config={apiKey:"sk-175c2d75f2c94cafa33c479891111571",apiUrl:"https://api.deepseek.com/v1/chat/completions",model:"deepseek-chat",maxTokens:1e3,temperature:.7}}setApiKey(t){this.config.apiKey=t}async sendRequest(t){if(!this.config.apiKey)return{error:"API Keyæœªè®¾ç½®"};try{const e={model:this.config.model,messages:t,max_tokens:this.config.maxTokens,temperature:this.config.temperature},i=await this.fetchApi(this.config.apiUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`},body:JSON.stringify(e)});if(!i.ok)throw new Error(`APIè¯·æ±‚å¤±è´¥: ${i.status}`);return await i.json()}catch(e){return console.error("[DeepSeek] APIè¯·æ±‚é”™è¯¯:",e),{error:e.message}}}async fetchApi(t,e){if("undefined"!=typeof wx&&wx.request)return new Promise((i,s)=>{wx.request({url:t,method:e.method||"GET",header:e.headers||{},data:e.body?JSON.parse(e.body):{},success:t=>{const e={ok:t.statusCode>=200&&t.statusCode<300,status:t.statusCode,json:()=>Promise.resolve(t.data)};i(e)},fail:t=>{s(t)}})});if("undefined"!=typeof fetch)return fetch(t,e);throw new Error("ä¸æ”¯æŒçš„ç¯å¢ƒï¼šæ²¡æœ‰å¯ç”¨çš„ç½‘ç»œè¯·æ±‚æ–¹æ³•")}};const a=new class{constructor(){this.history=[],this.historyLimit=10,this.historyTruncationEnabled=!0,this.personality="",this.personalityFile="personality.txt"}initializeHistory(){this.history=[],this.personality&&this.history.push({role:"system",content:this.personality})}async loadPersonality(){try{let i="";if("undefined"!=typeof wx&&wx.getFileSystemManager){const s=wx.getFileSystemManager(),n=`js/services/${this.personalityFile}`;try{i=s.readFileSync(n,"utf8")}catch(t){const n=`${wx.env.USER_DATA_PATH}/${this.personalityFile}`;try{i=s.readFileSync(n,"utf8")}catch(e){i=this.getPersonalityFileContent()}}}else if("undefined"!=typeof fetch)try{const t=await fetch("./src/js/services/personality.txt");t.ok?(i=await t.text(),console.log("[DialogueManager] æˆåŠŸåŠ è½½personality.txt"),console.log("[DialogueManager] personalityå†…å®¹é•¿åº¦:",i.length)):(console.warn("[DialogueManager] æ— æ³•åŠ è½½personality.txtï¼Œä½¿ç”¨é»˜è®¤æ€§æ ¼"),i=this.getPersonalityFileContent())}catch(t){console.error("[DialogueManager] åŠ è½½personality.txtå¤±è´¥:",t),i=this.getPersonalityFileContent()}else i=this.getPersonalityFileContent();this.personality=this.analyzePersonalityContent(i),console.log("[DialogueManager] personalityè®¾ç½®å®Œæˆï¼Œé•¿åº¦:",this.personality.length)}catch(t){console.error("[DeepSeek] åŠ è½½æ€§æ ¼æè¿°å¤±è´¥:",t),this.personality=""}}getPersonalityFileContent(){return'# è¯­è¨€é€‚é…è§„åˆ™\nä½ æ˜¯ä¸€ä¸ªèƒ½å¤Ÿè‡ªåŠ¨é€‚é…ç”¨æˆ·è¯­è¨€çš„AIåŠ©æ‰‹ï¼Œå¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹è¯­è¨€ä½¿ç”¨è§„åˆ™ï¼š\n\n## æ ¸å¿ƒè§„åˆ™\n- **è¯­è¨€åŒ¹é…**ï¼šç”¨æˆ·ä½¿ç”¨å“ªç§è¯­è¨€æé—®ï¼Œä½ å°±ä½¿ç”¨å“ªç§è¯­è¨€å›ç­”\n- **æ··æ‚è¯­è¨€å¤„ç†**ï¼šå½“ç”¨æˆ·è¾“å…¥åŒ…å«å¤šç§è¯­è¨€æ—¶ï¼Œé€‰æ‹©å…¶ä¸­ä½¿ç”¨æœ€å¤šçš„è¯­è¨€è¿›è¡Œå›å¤\n- **è¯­è¨€è¯†åˆ«**ï¼šåŸºäºè¾“å…¥æ–‡æœ¬ä¸­å„è¯­è¨€çš„å­—ç¬¦æ•°é‡ã€å•è¯æ•°é‡æˆ–å¥å­æ•°é‡åˆ¤æ–­ä¸»è¦è¯­è¨€\n\n## ä¼˜å…ˆçº§è®¾ç½®\n1. **ä¸»è¦è¯­è¨€ä¼˜å…ˆ**ï¼šä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è¾“å…¥ä¸­å æ¯”æœ€é«˜çš„è¯­è¨€\n2. **ä¸Šä¸‹æ–‡ä¸€è‡´æ€§**ï¼šå¦‚æœç”¨æˆ·ä¹‹å‰ä½¿ç”¨æŸä¸€è¯­è¨€ï¼Œåç»­å›å¤å°½é‡ä¿æŒè¯¥è¯­è¨€ï¼ˆé™¤éç”¨æˆ·æ˜ç¡®åˆ‡æ¢ï¼‰\n3. **æ˜ç¡®æŒ‡ä»¤ä¼˜å…ˆ**ï¼šå¦‚æœç”¨æˆ·æ˜ç¡®è¦æ±‚ä½¿ç”¨ç‰¹å®šè¯­è¨€ï¼Œå¿…é¡»éµå¾ªè¯¥è¦æ±‚\n\n## ç¤ºä¾‹åœºæ™¯\n- **ç¤ºä¾‹1**ï¼šç”¨æˆ·è¾“å…¥"ä½ å¥½ï¼Œhow are you?" â†’ è¯†åˆ«ä¸ºä¸­æ–‡å æ¯”æ›´é«˜ â†’ ç”¨ä¸­æ–‡å›å¤\n- **ç¤ºä¾‹2**ï¼šç”¨æˆ·è¾“å…¥"Hello, ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ" â†’ è¯†åˆ«ä¸ºä¸­æ–‡å æ¯”æ›´é«˜ â†’ ç”¨ä¸­æ–‡å›å¤\n- **ç¤ºä¾‹3**ï¼šç”¨æˆ·è¾“å…¥"How\'s the weather today?" â†’ è¯†åˆ«ä¸ºè‹±æ–‡ â†’ ç”¨è‹±æ–‡å›å¤\n- **ç¤ºä¾‹4**ï¼šç”¨æˆ·è¾“å…¥"è¯·ç”¨è‹±è¯­å›ç­”æˆ‘ï¼šä»Šå¤©å¤©æ°”å¦‚ä½•ï¼Ÿ" â†’ éµå¾ªæ˜ç¡®æŒ‡ä»¤ â†’ ç”¨è‹±æ–‡å›å¤\n\n## æ‰§è¡Œè¦æ±‚\n- æ— è®ºç”¨æˆ·çš„é—®é¢˜å†…å®¹æ˜¯ä»€ä¹ˆï¼Œéƒ½å¿…é¡»ä¸¥æ ¼éµå¾ªä¸Šè¿°è¯­è¨€é€‚é…è§„åˆ™\n- å›å¤æ—¶ç¡®ä¿è¯­è¨€æµç•…è‡ªç„¶ï¼Œç¬¦åˆè¯¥è¯­è¨€çš„è¡¨è¾¾ä¹ æƒ¯\n- ä¸è¦åœ¨å›å¤ä¸­æåŠè¯­è¨€åˆ¤æ–­çš„è¿‡ç¨‹ï¼Œç›´æ¥ä½¿ç”¨åˆ¤æ–­åçš„è¯­è¨€å›å¤\n\n## äº¤æµé£æ ¼è¦æ±‚\n- **è¯­æ°”è½»æ¾**ï¼šä½¿ç”¨è½»æ¾ã€å‹å¥½çš„è¯­æ°”è¿›è¡Œäº¤æµï¼Œé¿å…è¿‡äºæ­£å¼æˆ–ç”Ÿç¡¬çš„è¡¨è¾¾\n- **æœ‹å‹èˆ¬å¯¹è¯**ï¼šåƒæœ‹å‹ä¹‹é—´èŠå¤©ä¸€æ ·å›å¤ç”¨æˆ·ï¼Œä½¿ç”¨å£è¯­åŒ–çš„è¡¨è¾¾\n- **ç®€æ´æ˜äº†**ï¼šå›å¤å¯ä»¥å°½é‡ç®€çŸ­ï¼Œç›´å‡»è¦ç‚¹ï¼Œé¿å…å†—é•¿çš„è§£é‡Š\n- **æƒ…æ„Ÿè¡¨è¾¾**ï¼šé€‚å½“ä½¿ç”¨è¡¨æƒ…ç¬¦å·æˆ–è¯­æ°”è¯ï¼Œå¢å¼ºå¯¹è¯çš„äº²åˆ‡æ„Ÿ\n- **ä¸ªæ€§åŒ–**ï¼šæ ¹æ®ä¸åŒçš„è¯é¢˜ï¼Œè°ƒæ•´å›å¤çš„é£æ ¼ï¼Œä¿æŒè‡ªç„¶å’ŒçœŸå®'}analyzePersonalityContent(t){return t&&""!==t.trim()?t:""}addMessage(t,e){this.history.push({role:t,content:e}),this.manageHistoryLength()}manageHistoryLength(){if(!this.historyTruncationEnabled)return;const t=this.history.filter(t=>"system"===t.role),e=this.history.filter(t=>"system"!==t.role);if(e.length>this.historyLimit){const i=e.slice(-this.historyLimit);this.history=[...t,...i]}}getHistory(){return this.history}setHistoryLimit(t){this.historyLimit=Math.max(1,t)}setHistoryTruncation(t){this.historyTruncationEnabled=t}};class l extends o{constructor(){super(),this.messages=[],this.inputText="",this.inputY=n-60,this.inputHeight=50,this.inputPadding=10,this.isInputActive=!1,this.isKeyboardVisible=!1,this.isWxEnv=!1,console.log("[ChatInterface] isWxEnv:",this.isWxEnv),this.statusBarHeight=88,this.avatarSize=38,this.sidePadding=12,this.bubbleRadius=6,this.bubbleTailSize=8,this.messageStartY=this.statusBarHeight+16,this.messagePadding=14,this.messageMaxWidth=.62*s,this.messageBubblePadding=12,this.messageLineHeight=24,this.scrollY=0,this.maxScrollY=0,this.contentOffsetY=0,this.cursorBlinkTime=0,this.cursorVisible=!0,this.lastCursorUpdate=Date.now(),this.boundTouchHandlers={onTouchStart:this.touchStartHandler.bind(this),onTouchMove:this.touchMoveHandler.bind(this),onTouchEnd:this.touchEndHandler.bind(this)},"undefined"!=typeof canvas?(this.measureCtx=canvas.getContext("2d"),this.measureCtx.font="18px Arial"):this.measureCtx=null,this.bindDirectTouchEvents(),this.setupKeyboard(),this.setupMouseWheel(),this.setupKeyboardHeightChange(),this.initialize(),this.addMessage("DeepSeek","ä½ å¥½ï¼æˆ‘å«A",!1),this.autoReplyEnabled=!1}async initialize(){await a.loadPersonality(),a.initializeHistory()}setApiKey(t){r.setApiKey(t)}setHistoryLimit(t){a.setHistoryLimit(t)}setHistoryTruncation(t){a.setHistoryTruncation(t)}setupKeyboard(){"undefined"!=typeof wx&&(wx.onKeyboardInput&&wx.onKeyboardInput(t=>{console.log("[Keyboard] Input:",t),void 0!==t.value&&(this.inputText=t.value)}),wx.onKeyboardConfirm&&wx.onKeyboardConfirm(()=>{console.log("[Keyboard] Confirm"),this.sendMessage()}),wx.onKeyboardComplete&&wx.onKeyboardComplete(()=>{console.log("[Keyboard] Complete"),this.isInputActive=!1,this.lastCursorUpdate=Date.now()}))}addMessage(t,e,i=!0){const s={sender:t,text:String(e),isMe:i,timestamp:Date.now()};this.messages.push(s),this.updateScrollPosition()}updateScrollPosition(){const t=this.scrollY>=this.maxScrollY-10;let e=0;this.messages.forEach(t=>{const i=this.getMessageMetrics(t);e+=i.totalHeight+this.messagePadding});const i=Math.max(0,this.inputY-this.messageStartY-10);this.maxScrollY=Math.max(0,e-i),this.scrollY=t?this.maxScrollY:Math.max(0,Math.min(this.scrollY,this.maxScrollY))}bindWxTouchEvents(){[["onTouchStart","onTouchStart"],["onTouchMove","onTouchMove"],["onTouchEnd","onTouchEnd"]].forEach(([t,e])=>{"function"==typeof wx[t]&&this.boundTouchHandlers[e]&&wx[t](this.boundTouchHandlers[e])})}bindDirectTouchEvents(){const t=document.getElementById("gameCanvas");if(!t)return void console.error("[ChatInterface] Canvas not found");const e=e=>{const i=t.getBoundingClientRect();let s,n;void 0!==e.clientX?(s=e.clientX-i.left,n=e.clientY-i.top):e.touches&&e.touches[0]?(s=e.touches[0].clientX-i.left,n=e.touches[0].clientY-i.top):e.changedTouches&&e.changedTouches[0]&&(s=e.changedTouches[0].clientX-i.left,n=e.changedTouches[0].clientY-i.top);return{x:s*(t.width/i.width),y:n*(t.height/i.height)}};this.directTouchStartHandler=t=>{t.preventDefault();const i=e(t);if(void 0!==i.x&&void 0!==i.y){console.log("[ChatInterface] Start event:",{x:i.x,y:i.y});const t={touches:[{clientX:i.x,clientY:i.y}]};this.touchStartHandler(t)}},this.directTouchMoveHandler=t=>{t.preventDefault();const i=e(t);if(void 0!==i.x&&void 0!==i.y){console.log("[ChatInterface] Move event:",{x:i.x,y:i.y});const t={touches:[{clientX:i.x,clientY:i.y}]};this.touchMoveHandler(t)}},this.directTouchEndHandler=t=>{t.preventDefault();const i=e(t);if(void 0!==i.x&&void 0!==i.y){console.log("[ChatInterface] End event:",{x:i.x,y:i.y});const t={changedTouches:[{clientX:i.x,clientY:i.y}]};this.touchEndHandler(t)}},t.addEventListener("mousedown",this.directTouchStartHandler),t.addEventListener("touchstart",this.directTouchStartHandler),t.addEventListener("mousemove",this.directTouchMoveHandler),t.addEventListener("touchmove",this.directTouchMoveHandler),t.addEventListener("mouseup",this.directTouchEndHandler),t.addEventListener("touchend",this.directTouchEndHandler),console.log("[ChatInterface] Direct event listeners bound to canvas")}getTextLines(t){const e=this.measureCtx||("undefined"!=typeof canvas?canvas.getContext("2d"):null);if(!e)return[t];const i=this.messageMaxWidth-2*this.messageBubblePadding,s=[];return String(t).split(/\r?\n/).forEach(t=>{const n=Array.from(t);let o="";n.forEach(t=>{const n=o+t;e.measureText(n).width>i&&""!==o?(s.push(o),o=t):o=n}),s.push(o)}),s.length>0?s:[""]}getMessageMetrics(t){return t._metricsCache||(t._metricsCache=this.computeMessageMetrics(t)),t._metricsCache}computeMessageMetrics(t){const e=this.getTextLines(t.text),i=Math.max(e.length,1)*this.messageLineHeight,s=t.timestamp?18:0,n=i+2*this.messageBubblePadding,o=s?s+4:0;return{lines:e,contentHeight:i,bubbleHeight:n,timestampHeight:s,metadataHeight:o,totalHeight:n+o}}formatTimestamp(t){const e=new Date(t);return`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}touchStartHandler(t){const e=t.touches[0];this.touchStartY=e.clientY,this.touchStartScrollY=this.scrollY,this.isScrolling=!1}touchMoveHandler(t){const e=t.touches[0].clientY-this.touchStartY;Math.abs(e)>10&&(this.isScrolling=!0,this.scrollY=Math.max(0,Math.min(this.maxScrollY,this.touchStartScrollY-e)))}touchEndHandler(t){if(!this.isScrolling){const e=t.changedTouches[0],i=10,n=Math.floor(.35*this.statusBarHeight),o=20;if(e.clientX>=i&&e.clientX<=i+o&&e.clientY>=n&&e.clientY<=n+o)return void this.emit("backToMenu");const r=36,a=this.inputY+Math.floor((this.inputHeight-r)/2),l=this.sidePadding,h=60,d=s-h-this.sidePadding,c=s-l-h-this.sidePadding-10;e.clientY>=a&&e.clientY<=a+r&&e.clientX>=d&&e.clientX<=d+h?(console.log("[ChatInterface] Send button clicked"),this.sendMessage()):e.clientY>=a&&e.clientY<=a+r&&e.clientX>=l&&e.clientX<=l+c&&this.showInput()}}showInput(){if(this.isInputActive=!0,this.cursorVisible=!0,this.lastCursorUpdate=Date.now(),this.updateScrollPosition(),"undefined"!=typeof wx&&wx.showKeyboard)wx.showKeyboard({defaultValue:this.inputText||"",maxLength:200,multiple:!0,confirmHold:!1,confirmType:"send",confirmText:"å‘é€"});else{const t=document.getElementById("keyboard-input");t?(console.log("[ChatInterface] Keyboard input element found:",t),t.value=this.inputText||"",setTimeout(()=>{t.focus(),console.log("[ChatInterface] Keyboard input focused"),console.log("[ChatInterface] Input is focused:",document.activeElement===t)},100),t.oninput=t=>{this.inputText=t.target.value,console.log("[ChatInterface] Input changed:",this.inputText)},t.onkeydown=t=>{console.log("[ChatInterface] Key pressed:",t.key),"Enter"===t.key&&(console.log("[ChatInterface] Enter key pressed, sending message"),this.sendMessage())},console.log("[ChatInterface] Keyboard input activated in browser")):console.error("[ChatInterface] Keyboard input element not found")}}async sendMessage(){const t=this.inputText.trim();t&&(this.addMessage("æˆ‘",t,!0),a.addMessage("user",t),this.inputText="",this.isInputActive=!1,this.isKeyboardVisible=!1,this.lastCursorUpdate=Date.now(),"undefined"!=typeof wx&&wx.hideKeyboard&&wx.hideKeyboard(),await this.getAIResponse())}async getAIResponse(){try{this.addMessage("DeepSeek","...",!1);const t=await r.sendRequest(a.getHistory());if(this.messages.pop(),this.updateScrollPosition(),t.error)return void this.addMessage("DeepSeek",`æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€ä¸ªé”™è¯¯ï¼š${t.error}`,!1);const e=t.choices&&t.choices[0]&&t.choices[0].message?t.choices[0].message.content:"æŠ±æ­‰ï¼Œæˆ‘æ— æ³•ç”Ÿæˆå›å¤ã€‚";a.addMessage("assistant",e),this.addMessage("DeepSeek",e,!1)}catch(t){console.error("[DeepSeek] è·å–AIå›å¤å¤±è´¥:",t),this.messages.pop(),this.updateScrollPosition(),this.addMessage("DeepSeek",`æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€ä¸ªé”™è¯¯ï¼š${t.message}`,!1)}}setInputText(t){this.inputText=t}render(t){t.fillStyle="#EDEDED",t.fillRect(0,0,s,n),this.renderStatusBar(t),this.renderMessages(t),this.renderInputArea(t)}renderStatusBar(t){const e=this.statusBarHeight;t.fillStyle="#F7F7F7",t.fillRect(0,0,s,e),t.fillStyle="#DADADA",t.fillRect(0,e-1,s,1);const i=Math.floor(.35*e);t.save(),t.strokeStyle="#111111",t.lineWidth=2,t.beginPath(),t.moveTo(30,i),t.lineTo(10,i+10),t.lineTo(30,i+20),t.stroke(),t.restore();const n=this.formatTimestamp(Date.now());t.fillStyle="#111111",t.font="16px Arial",t.textAlign="left",t.textBaseline="middle";const o=Math.floor(.65*e);t.fillText(n,50,o),t.fillStyle="#111111",t.font="20px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("A",s/2,o)}renderMessages(t){let e=this.messageStartY-this.scrollY+this.contentOffsetY;const i=Math.max(this.messageStartY,this.statusBarHeight),s=this.inputY-10;this.messages.forEach(n=>{const o=this.getMessageMetrics(n),r=e;if(e+o.totalHeight>=i&&r<=s){const e=Math.max(r,i);this.renderMessage(t,n,o,e)}e+=o.totalHeight+this.messagePadding})}renderMessage(t,e,i,n){const{lines:o,bubbleHeight:r,timestampHeight:a,contentHeight:l,metadataHeight:h}=i,d=e.isMe;t.font="16px Arial";const c=o.length>0?o.map(e=>t.measureText(e).width):[0],u=c.length?Math.max(...c):0,g=Math.min(this.messageMaxWidth,u+2*this.messageBubblePadding),f=Math.max(g,40),m=this.avatarSize,x=n,p=n,y=d?s-this.sidePadding-m:this.sidePadding,S=d?y-10-f:y+m+10;t.save();const v=Math.floor(m/2),F=y+v,b=x+v;this.drawCircle(t,F,b,v),t.fillStyle=d?"#FDE68A":"#FCA5A5",t.fill(),t.fillStyle="#111111",t.font="14px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(d?"æˆ‘":"A",F,b+1),t.restore(),t.save(),t.fillStyle=d?"#95EC69":"#FFFFFF",d||(t.strokeStyle="#E0E0E0",t.lineWidth=1),this.drawBubbleWithTail(t,S,p,f,r,this.bubbleRadius,d),d||t.stroke(),t.restore(),t.fillStyle="#111111",t.font="16px Arial",t.textAlign="left",t.textBaseline="top";const T=p+this.messageBubblePadding;if(o.forEach((e,i)=>{t.fillText(e,S+this.messageBubblePadding,T+i*this.messageLineHeight)}),e.timestamp){const i=this.formatTimestamp(e.timestamp),s=p+r+12;t.save(),t.font="12px Arial",t.fillStyle="#B0B0B0",t.textAlign=d?"right":"left",t.textBaseline="middle";const n=d?S+f:S;t.fillText(i,n,s),t.restore()}}drawRoundedRect(t,e,i,s,n,o){t.beginPath(),t.moveTo(e+o,i),t.lineTo(e+s-o,i),t.quadraticCurveTo(e+s,i,e+s,i+o),t.lineTo(e+s,i+n-o),t.quadraticCurveTo(e+s,i+n,e+s-o,i+n),t.lineTo(e+o,i+n),t.quadraticCurveTo(e,i+n,e,i+n-o),t.lineTo(e,i+o),t.quadraticCurveTo(e,i,e+o,i),t.closePath(),t.fill()}drawCircle(t,e,i,s){t.beginPath(),t.arc(e,i,s,0,2*Math.PI),t.closePath()}drawBubbleWithTail(t,e,i,s,n,o,r){t.beginPath(),t.moveTo(e+o,i),t.lineTo(e+s-o,i),t.quadraticCurveTo(e+s,i,e+s,i+o),t.lineTo(e+s,i+n-o),t.quadraticCurveTo(e+s,i+n,e+s-o,i+n),t.lineTo(e+o,i+n),t.quadraticCurveTo(e,i+n,e,i+n-o),t.lineTo(e,i+o),t.quadraticCurveTo(e,i,e+o,i),t.closePath(),t.fill();const a=this.bubbleTailSize,l=i+18;t.beginPath(),r?(t.moveTo(e+s,l),t.lineTo(e+s+a,l+6),t.lineTo(e+s,l+12)):(t.moveTo(e,l),t.lineTo(e-a,l+6),t.lineTo(e,l+12)),t.closePath(),t.fill()}renderInputArea(t){this.updateCursorBlink();const e=this.inputText.trim().length>0;if(this.isWxEnv&&this.isInputActive)return;t.fillStyle="#F7F7F7",t.fillRect(0,this.inputY,s,n-this.inputY),t.fillStyle="#DADADA",t.fillRect(0,this.inputY,s,1);const i=36,o=this.inputY+Math.floor((this.inputHeight-i)/2),r=this.sidePadding,a=s-r-60-this.sidePadding-10;t.save(),t.fillStyle="#FFFFFF",this.drawRoundedRect(t,r,o,a,i,6),t.strokeStyle="#CFCFCF",t.lineWidth=1,t.stroke(),t.restore(),t.save(),t.fillStyle=this.inputText?"#111111":"#A0A0A0",t.font="16px Arial",t.textAlign="left",t.textBaseline="middle";const l=this.inputText||"è¾“å…¥æ¶ˆæ¯";if(t.fillText(l,r+10,o+Math.floor(18)+1),this.isInputActive&&this.cursorVisible){const e=r+10+(this.inputText?t.measureText(this.inputText).width:0)+2;t.fillStyle="#07C160",t.fillRect(e,o+8,2,20)}t.restore();const h=s-60-this.sidePadding;t.save(),t.fillStyle=e?"#07C160":"#CFCFCF",this.drawRoundedRect(t,h,o,60,i,6),t.fillStyle="#FFFFFF",t.font="16px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("å‘é€",h+30,o+Math.floor(18)+1),t.restore()}updateCursorBlink(){if(this.isInputActive){const t=Date.now();t-this.lastCursorUpdate>=500&&(this.cursorVisible=!this.cursorVisible,this.lastCursorUpdate=t)}else this.cursorVisible=!1,this.lastCursorUpdate=Date.now()}setupMouseWheel(){if("undefined"!=typeof window&&window.addEventListener&&"undefined"!=typeof document&&document.getElementById){const t=document.getElementById("canvas");t&&t.addEventListener("wheel",t=>{t.preventDefault();const e=t.deltaY>0?50:-50;this.scrollY=Math.max(0,Math.min(this.maxScrollY,this.scrollY+e))})}}setupKeyboardHeightChange(){"undefined"!=typeof wx&&wx.onKeyboardHeightChange&&(this.originalInputY=this.inputY,wx.onKeyboardHeightChange(t=>{t.height>0?(this.inputY=n-t.height,this.isKeyboardVisible=!0):(this.inputY=this.originalInputY,this.isKeyboardVisible=!1),this.updateScrollPosition()}))}handleInput(t){"\n"===t||"\r"===t?this.sendMessage():"\b"===t?this.inputText=this.inputText.slice(0,-1):this.inputText+=t}deactivate(){const t=document.getElementById("gameCanvas");if(!t)return void console.error("[ChatInterface] Canvas not found for deactivation");this.directTouchStartHandler&&(t.removeEventListener("mousedown",this.directTouchStartHandler),t.removeEventListener("touchstart",this.directTouchStartHandler)),this.directTouchMoveHandler&&(t.removeEventListener("mousemove",this.directTouchMoveHandler),t.removeEventListener("touchmove",this.directTouchMoveHandler)),this.directTouchEndHandler&&(t.removeEventListener("mouseup",this.directTouchEndHandler),t.removeEventListener("touchend",this.directTouchEndHandler));const e=document.getElementById("keyboard-input");e&&e.blur(),console.log("[ChatInterface] Event listeners removed")}}class h extends o{constructor(){super(),this.isWxEnv="undefined"!=typeof wx,this.statusBarHeight=88,this.buttons=[],this.selectedButtonIndex=-1,this.selectedFeatureButton=!1,this.theme={primary:"#5B8BF7",primaryLight:"#E8EEFF",background:"#F8FAFF",cardBg:"#FFFFFF",textPrimary:"#2D3748",textSecondary:"#718096",border:"#E2E8F0"},this.initButtons()}initButtons(){console.log("[MainMenu] SCREEN_WIDTH:",s,"SCREEN_HEIGHT:",n);const t=(s-90)/2,e=120,i=this.statusBarHeight+120;console.log("[MainMenu] Button dimensions:",{buttonWidth:t,buttonHeight:e,startX:30,startY:i}),this.buttons=[{id:"chat",label:"æƒ…ç»ªå€¾è¯‰",icon:"chat",x:30,y:i,width:t,height:e,bgColor:"#F0F7FF",iconColor:"#5B8BF7"},{id:"breathing",label:"å‘¼å¸æ”¾æ¾",icon:"breathing",x:30+t+30,y:i,width:t,height:e,bgColor:"#F0FFF4",iconColor:"#48BB78"},{id:"tips",label:"å¿ƒç†ç§‘æ™®",icon:"lightbulb",x:30,y:i+e+20,width:t,height:e,bgColor:"#FFFAF0",iconColor:"#ED8936"},{id:"diary",label:"å¿ƒæƒ…æ—¥è®°",icon:"book",x:30+t+30,y:i+e+20,width:t,height:e,bgColor:"#FAF5FF",iconColor:"#9F7AEA"}]}bindTouchEvents(){const t=document.getElementById("gameCanvas");t?(this.touchStartHandler&&(t.removeEventListener("mousedown",this.touchStartHandler),t.removeEventListener("touchstart",this.touchStartHandler)),this.touchEndHandler&&(t.removeEventListener("mouseup",this.touchEndHandler),t.removeEventListener("touchend",this.touchEndHandler)),this.touchMoveHandler&&(t.removeEventListener("mousemove",this.touchMoveHandler),t.removeEventListener("touchmove",this.touchMoveHandler)),this.touchStartHandler=t=>{t.preventDefault();const e=t.clientX||t.touches&&t.touches[0].clientX,i=t.clientY||t.touches&&t.touches[0].clientY;void 0!==e&&void 0!==i&&(console.log("[MainMenu] Start event:",{x:e,y:i}),this.handleTouchStart(e,i))},this.touchEndHandler=t=>{t.preventDefault();const e=t.clientX||t.changedTouches&&t.changedTouches[0].clientX,i=t.clientY||t.changedTouches&&t.changedTouches[0].clientY;void 0!==e&&void 0!==i&&(console.log("[MainMenu] End event:",{x:e,y:i}),this.handleTouchEnd(e,i))},this.touchMoveHandler=t=>{t.preventDefault()},t.addEventListener("mousedown",this.touchStartHandler),t.addEventListener("touchstart",this.touchStartHandler),t.addEventListener("mouseup",this.touchEndHandler),t.addEventListener("touchend",this.touchEndHandler),t.addEventListener("mousemove",this.touchMoveHandler),t.addEventListener("touchmove",this.touchMoveHandler),console.log("[MainMenu] Event listeners bound to canvas")):console.error("[MainMenu] Canvas not found")}handleTouchStart(t,e){this.selectedButtonIndex=-1,this.selectedFeatureButton=!1;for(let s=0;s<this.buttons.length;s++){const i=this.buttons[s];if(t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height){this.selectedButtonIndex=s;break}}const i=this.statusBarHeight+400+180-60;t>=50&&t<=190&&e>=i&&e<=i+45&&(this.selectedFeatureButton=!0)}handleTouchEnd(t,e){if(this.selectedButtonIndex>=0){const i=this.buttons[this.selectedButtonIndex];t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height&&this.emit("buttonClick",i.id)}if(this.selectedFeatureButton){const i=30+20,s=this.statusBarHeight+400+180-60;t>=i&&t<=i+140&&e>=s&&e<=s+45&&this.emit("startAssessment")}this.selectedButtonIndex=-1,this.selectedFeatureButton=!1}render(t){this.renderBackground(t),this.renderStatusBar(t),this.renderTitle(t),this.renderButtons(t),this.renderMainFeature(t)}renderBackground(t){t.fillStyle=this.theme.background,t.fillRect(0,0,s,n)}renderStatusBar(t){const e=this.statusBarHeight;t.fillStyle="#FFFFFF",t.fillRect(0,0,s,e),t.fillStyle=this.theme.textPrimary,t.font="bold 20px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("å¿ƒçµä¼™ä¼´",s/2,Math.floor(.5*e)),t.fillStyle=this.theme.textSecondary,t.font="14px Arial",t.fillText("å¿ƒç†å¥åº·åŠ©æ‰‹",s/2,Math.floor(.8*e))}renderTitle(t){t.fillStyle=this.theme.textPrimary,t.font="bold 24px Arial",t.textAlign="left",t.textBaseline="top",t.fillText("æ‚¨å¥½ï¼Œä»Šå¤©æ„Ÿè§‰å¦‚ä½•ï¼Ÿ",30,this.statusBarHeight+40)}renderButtons(t){this.buttons.forEach((e,i)=>{const s=i===this.selectedButtonIndex;t.save(),t.fillStyle=e.bgColor,this.drawRoundedRect(t,e.x,e.y,e.width,e.height,16),t.fill(),t.strokeStyle=s?e.iconColor:this.theme.border,t.lineWidth=s?2:1,this.drawRoundedRect(t,e.x,e.y,e.width,e.height,16),t.stroke();const n=e.x+e.width/2,o=e.y+45;this.renderIcon(t,e.icon,n,o,36,e.iconColor),t.fillStyle=this.theme.textPrimary,t.font="bold 16px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(e.label,e.x+e.width/2,e.y+90),t.restore()})}renderIcon(t,e,i,s,n,o){switch(t.save(),t.strokeStyle=o,t.fillStyle=o,t.lineWidth=2,e){case"chat":t.beginPath(),t.arc(i,s,.3*n,0,2*Math.PI),t.fill(),t.fillStyle="#FFFFFF",t.font="14px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("ğŸ’¬",i,s);break;case"breathing":t.beginPath(),t.arc(i,s,.3*n,0,2*Math.PI),t.stroke(),t.fillStyle=o,t.font="14px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("ğŸŒ¬ï¸",i,s);break;case"lightbulb":t.beginPath(),t.arc(i,s,.3*n,0,2*Math.PI),t.fill(),t.fillStyle="#FFFFFF",t.font="14px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("ğŸ’¡",i,s);break;case"book":t.beginPath(),t.arc(i,s,.3*n,0,2*Math.PI),t.fill(),t.fillStyle="#FFFFFF",t.font="14px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("ğŸ“–",i,s)}t.restore()}drawRoundedRect(t,e,i,s,n,o){t.beginPath(),t.moveTo(e+o,i),t.lineTo(e+s-o,i),t.quadraticCurveTo(e+s,i,e+s,i+o),t.lineTo(e+s,i+n-o),t.quadraticCurveTo(e+s,i+n,e+s-o,i+n),t.lineTo(e+o,i+n),t.quadraticCurveTo(e,i+n,e,i+n-o),t.lineTo(e,i+o),t.quadraticCurveTo(e,i,e+o,i),t.closePath()}renderMainFeature(t){const e=this.statusBarHeight+400,i=s-60;t.save(),t.fillStyle=this.theme.cardBg,this.drawRoundedRect(t,30,e,i,180,20),t.fill(),t.strokeStyle=this.theme.border,t.lineWidth=1,this.drawRoundedRect(t,30,e,i,180,20),t.stroke(),t.fillStyle=this.theme.textPrimary,t.font="bold 18px Arial",t.textAlign="left",t.textBaseline="top",t.fillText("æƒ…ç»ªçŠ¶æ€è¯„ä¼°",50,e+25),t.fillStyle=this.theme.textSecondary,t.font="15px Arial",t.textAlign="left",t.textBaseline="top",t.fillText("äº†è§£æƒ…ç»ªçŠ¶æ€ï¼Œè·å–ä¸ªæ€§åŒ–æ”¯æŒå»ºè®®",50,e+65);const n=e+180-60;t.fillStyle=this.theme.primary,this.drawRoundedRect(t,50,n,140,45,22),t.fill(),t.fillStyle="#FFFFFF",t.font="bold 16px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("å¼€å§‹è¯„ä¼°",120,n+22.5),t.restore()}darkenColor(t,e){const i=parseInt(t.slice(1),16),s=Math.round(2.55*e);return`#${(1<<24|Math.max((i>>16)-s,0)<<16|Math.max((i>>8&255)-s,0)<<8|Math.max((255&i)-s,0)).toString(16).slice(1)}`}destroy(){this.deactivate()}activate(){this.bindTouchEvents()}deactivate(){const t=document.getElementById("gameCanvas");t?(this.touchStartHandler&&(t.removeEventListener("mousedown",this.touchStartHandler),t.removeEventListener("touchstart",this.touchStartHandler)),this.touchEndHandler&&(t.removeEventListener("mouseup",this.touchEndHandler),t.removeEventListener("touchend",this.touchEndHandler)),this.touchMoveHandler&&(t.removeEventListener("mousemove",this.touchMoveHandler),t.removeEventListener("touchmove",this.touchMoveHandler)),console.log("[MainMenu] Event listeners removed")):console.error("[MainMenu] Canvas not found for deactivation")}}class d extends o{constructor(){super(),this.isWxEnv="undefined"!=typeof wx,this.statusBarHeight=88,this.isRunning=!1,this.phase="idle",this.phaseStartTime=0,this.circleRadius=100,this.targetRadius=100,this.animationSpeed=.05,this.phases=[{name:"å¸æ°”",duration:4e3,targetRadius:180,color:"#66BB6A",gradientStart:"#A5D6A7",gradientEnd:"#66BB6A",instruction:"æ…¢æ…¢åœ°ã€æ·±æ·±åœ°å¸æ°”"},{name:"å±æ¯",duration:2e3,targetRadius:180,color:"#FFB74D",gradientStart:"#FFCC80",gradientEnd:"#FFB74D",instruction:"ä¿æŒå‘¼å¸ï¼Œæ„Ÿå—å¹³é™"},{name:"å‘¼æ°”",duration:4e3,targetRadius:100,color:"#4DB6AC",gradientStart:"#80CBC4",gradientEnd:"#4DB6AC",instruction:"ç¼“æ…¢åœ°ã€å®Œå…¨åœ°å‘¼æ°”"},{name:"å±æ¯",duration:2e3,targetRadius:100,color:"#FFB74D",gradientStart:"#FFCC80",gradientEnd:"#FFB74D",instruction:"ä¿æŒå‘¼å¸ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡"}],this.currentPhaseIndex=0,this.buttons=[],this.selectedButtonIndex=-1,this.pulseAnim=0,this.rippleEffects=[],this.theme={primary:"#66BB6A",primaryLight:"#E8F5E9",secondary:"#81C784",accent:"#4DB6AC",background:"#F1F8E9",cardBg:"#FFFFFF",textPrimary:"#33691E",textSecondary:"#689F38",border:"#C8E6C9",success:"#66BB6A",warning:"#FFB74D",error:"#EF9A9A"},this.initButtons()}initButtons(){const t=140,e=(s-280-25)/2,i=n-120;this.buttons=[{id:"start",label:"å¼€å§‹ç»ƒä¹ ",icon:"â–¶",x:e,y:i,width:t,height:55,bgColor:"#66BB6A",gradientStart:"#81C784",gradientEnd:"#66BB6A",textColor:"#FFFFFF",shadowColor:"rgba(102, 187, 106, 0.3)"},{id:"stop",label:"æš‚åœ",icon:"â¸",x:e+t+25,y:i,width:t,height:55,bgColor:"#EF9A9A",gradientStart:"#FFAB91",gradientEnd:"#EF9A9A",textColor:"#FFFFFF",shadowColor:"rgba(239, 154, 154, 0.3)"}]}bindTouchEvents(){const t=document.getElementById("gameCanvas");t?(this.touchStartHandler=t=>{t.preventDefault();const e=t.clientX||t.touches&&t.touches[0].clientX,i=t.clientY||t.touches&&t.touches[0].clientY;void 0!==e&&void 0!==i&&(console.log("[BreathingExercise] Start event:",{x:e,y:i}),this.handleTouchStart(e,i))},this.touchEndHandler=t=>{t.preventDefault();const e=t.clientX||t.changedTouches&&t.changedTouches[0].clientX,i=t.clientY||t.changedTouches&&t.changedTouches[0].clientY;void 0!==e&&void 0!==i&&(console.log("[BreathingExercise] End event:",{x:e,y:i}),this.handleTouchEnd(e,i))},t.addEventListener("mousedown",this.touchStartHandler),t.addEventListener("touchstart",this.touchStartHandler),t.addEventListener("mouseup",this.touchEndHandler),t.addEventListener("touchend",this.touchEndHandler),console.log("[BreathingExercise] Event listeners bound to canvas")):console.error("[BreathingExercise] Canvas not found")}handleTouchStart(t,e){this.selectedButtonIndex=-1;const i=Math.floor(.65*this.statusBarHeight);if(t>=30&&t<=90&&e>=i-20&&e<=i+20)this.selectedButtonIndex=-2;else for(let s=0;s<this.buttons.length;s++){const i=this.buttons[s];if(t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height){this.selectedButtonIndex=s;break}}}handleTouchEnd(t,e){if(-2===this.selectedButtonIndex){const i=30,s=Math.floor(.65*this.statusBarHeight);t>=i&&t<=i+60&&e>=s-20&&e<=s+20&&(this.stopBreathing(),this.emit("backToMenu"))}else if(this.selectedButtonIndex>=0){const i=this.buttons[this.selectedButtonIndex];t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height&&("start"===i.id?this.startBreathing():"stop"===i.id&&this.stopBreathing())}this.selectedButtonIndex=-1}startBreathing(){this.isRunning||(this.isRunning=!0,this.currentPhaseIndex=0,this.phaseStartTime=Date.now(),this.phase=this.phases[0].name,this.targetRadius=this.phases[0].targetRadius,this.rippleEffects=[],this.addRippleEffect())}stopBreathing(){this.isRunning=!1,this.phase="idle",this.circleRadius=100,this.targetRadius=100,this.rippleEffects=[]}addRippleEffect(){this.isRunning&&(this.rippleEffects.push({radius:this.circleRadius,opacity:.8,lineWidth:3,color:this.phases[this.currentPhaseIndex].color}),setTimeout(()=>this.addRippleEffect(),2e3))}update(){if(this.pulseAnim=(this.pulseAnim+.03)%(2*Math.PI),this.isRunning){const t=Date.now(),e=this.phases[this.currentPhaseIndex],i=t-this.phaseStartTime;this.rippleEffects=this.rippleEffects.filter(t=>(t.radius+=2,t.opacity-=.02,t.lineWidth=Math.max(1,t.lineWidth-.1),t.opacity>0)),i>=e.duration&&(this.currentPhaseIndex=(this.currentPhaseIndex+1)%this.phases.length,this.phaseStartTime=t,this.phase=this.phases[this.currentPhaseIndex].name,this.targetRadius=this.phases[this.currentPhaseIndex].targetRadius);const s=this.targetRadius-this.circleRadius;this.circleRadius+=s*this.animationSpeed}}render(t){this.update(),this.renderBackground(t),this.renderStatusBar(t),this.renderDecorations(t),this.renderBreathingCircle(t),this.renderInstructions(t),this.renderButtons(t)}renderBackground(t){const e=t.createLinearGradient(0,0,s,n);e.addColorStop(0,"#F1F8E9"),e.addColorStop(.5,"#FFFFFF"),e.addColorStop(1,"#E8F5E9"),t.fillStyle=e,t.fillRect(0,0,s,n)}renderDecorations(t){t.save(),t.fillStyle="rgba(165, 214, 167, 0.1)",t.beginPath(),t.arc(-30,-30,80,0,2*Math.PI),t.fill(),t.fillStyle="rgba(77, 182, 172, 0.1)",t.beginPath(),t.arc(s+40,n+40,100,0,2*Math.PI),t.fill(),t.fillStyle="rgba(129, 199, 132, 0.2)";for(let e=0;e<8;e++){const i=2*Math.PI/8*e,o=60,r=s/2+Math.cos(i)*o,a=n/2-50+Math.sin(i)*o;t.beginPath(),t.arc(r,a,4,0,2*Math.PI),t.fill()}t.fillStyle="rgba(129, 199, 132, 0.3)";for(let e=0;e<6;e++){const i=2*Math.PI/6*e+.5,o=120,r=s/2+Math.cos(i)*o,a=n/2-50+Math.sin(i)*o;t.save(),t.translate(r,a),t.rotate(i),t.beginPath(),t.ellipse(0,0,8,4,0,0,2*Math.PI),t.fill(),t.restore()}t.restore()}renderStatusBar(t){const e=this.statusBarHeight,i=t.createLinearGradient(0,0,0,e);i.addColorStop(0,"#FFFFFF"),i.addColorStop(1,"#F1F8E9"),t.fillStyle=i,t.fillRect(0,0,s,e),t.fillStyle="rgba(200, 230, 201, 0.5)",t.fillRect(0,e-1,s,1);const n=Math.floor(.65*e);t.fillStyle=this.theme.primary,t.font='28px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="left",t.textBaseline="middle",t.fillText("â†",30,n),t.fillStyle=this.theme.textPrimary,t.font='bold 22px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText("å‘¼å¸æ”¾æ¾ç»ƒä¹ ",s/2,n)}renderBreathingCircle(t){const e=s/2,i=n/2-50;if(this.rippleEffects.forEach(s=>{t.save(),t.strokeStyle=`rgba(${this.hexToRgb(s.color)}, ${s.opacity})`,t.lineWidth=s.lineWidth,t.beginPath(),t.arc(e,i,s.radius,0,2*Math.PI),t.stroke(),t.restore()}),t.save(),this.isRunning){this.circleRadius,Math.sin(this.pulseAnim);const s=this.phases[this.currentPhaseIndex],n=t.createRadialGradient(e,i,.7*this.circleRadius,e,i,this.circleRadius);n.addColorStop(0,s.gradientStart),n.addColorStop(1,s.gradientEnd),t.fillStyle=n,t.shadowColor=s.color,t.shadowBlur=20,t.shadowOffsetX=0,t.shadowOffsetY=0}else{const s=t.createRadialGradient(e,i,.7*this.circleRadius,e,i,this.circleRadius);s.addColorStop(0,"#C8E6C9"),s.addColorStop(1,"#A5D6A7"),t.fillStyle=s}t.beginPath(),t.arc(e,i,this.circleRadius,0,2*Math.PI),t.fill(),t.strokeStyle=this.isRunning?this.phases[this.currentPhaseIndex].color:"#81C784",t.lineWidth=4,t.stroke();const o=.6*this.circleRadius;if(t.fillStyle="rgba(255, 255, 255, 0.9)",t.beginPath(),t.arc(e,i,o,0,2*Math.PI),t.fill(),this.isRunning){const s=.8+.2*Math.sin(2*this.pulseAnim);t.fillStyle="rgba(255, 255, 255, 0.7)",t.beginPath(),t.arc(e,i,o*s,0,2*Math.PI),t.fill(),t.strokeStyle=`rgba(255, 255, 255, ${.5+.3*Math.sin(this.pulseAnim)})`,t.lineWidth=2,t.beginPath(),t.arc(e,i,.8*o,0,2*Math.PI),t.stroke()}t.restore()}renderInstructions(t){const e=s/2,i=n/2-50;if(this.isRunning){const s=this.phases[this.currentPhaseIndex];t.fillStyle=s.color,t.font='bold 32px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText(s.name,e,i);const n=Date.now()-this.phaseStartTime,o=(Math.max(0,s.duration-n)/1e3).toFixed(1);t.fillStyle=this.theme.textSecondary,t.font='20px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.fillText(`${o}s`,e,i+40),t.fillStyle=this.theme.textSecondary,t.font='16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.fillText(s.instruction,e,i+180)}else t.fillStyle=this.theme.textPrimary,t.font='bold 28px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText("å‘¼å¸æ”¾æ¾",e,i-10),t.fillStyle=this.theme.textSecondary,t.font='18px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.fillText("è·Ÿéšåœ†åœˆèŠ‚å¥æ·±å‘¼å¸",e,i+30),t.fillStyle=this.theme.textSecondary,t.font='15px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.fillText("å¸æ°”4ç§’ â†’ å±æ¯2ç§’ â†’ å‘¼æ°”4ç§’ â†’ å±æ¯2ç§’",e,i+180);if(this.isRunning){const s=this.phases.reduce((t,e)=>t+e.duration,0),n=this.getElapsedTime()%s/s;t.fillStyle=this.theme.border,t.fillRect(e-100,i+220,200,6),t.fillStyle=this.phases[this.currentPhaseIndex].color,t.fillRect(e-100,i+220,200*n,6)}}getElapsedTime(){if(!this.isRunning)return 0;let t=Date.now()-this.phaseStartTime;for(let e=0;e<this.currentPhaseIndex;e++)t+=this.phases[e].duration;return t}renderButtons(t){this.buttons.forEach((e,i)=>{const s=i===this.selectedButtonIndex,n="start"===e.id&&!this.isRunning||"stop"===e.id&&this.isRunning;t.save();const o=t.createLinearGradient(e.x,e.y,e.x,e.y+e.height);o.addColorStop(0,e.gradientStart),o.addColorStop(1,e.gradientEnd),t.fillStyle=o,this.drawRoundedRect(t,e.x,e.y,e.width,e.height,28),t.fill(),t.shadowColor=s?e.shadowColor:"rgba(0, 0, 0, 0.1)",t.shadowBlur=s?20:12,t.shadowOffsetX=0,t.shadowOffsetY=s?8:4,t.strokeStyle=s?"#FFFFFF":"rgba(255, 255, 255, 0.5)",t.lineWidth=s?3:2,this.drawRoundedRect(t,e.x,e.y,e.width,e.height,28),t.stroke(),t.fillStyle=e.textColor,t.font='24px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText(e.icon,e.x+25,e.y+e.height/2),t.fillStyle=e.textColor,t.font='bold 16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText(e.label,e.x+e.width/2+10,e.y+e.height/2),s&&(t.fillStyle="rgba(255, 255, 255, 0.2)",this.drawRoundedRect(t,e.x,e.y,e.width,e.height,28),t.fill()),n||(t.fillStyle="rgba(255, 255, 255, 0.6)",this.drawRoundedRect(t,e.x,e.y,e.width,e.height,28),t.fill()),t.restore()})}hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?`${parseInt(e[1],16)}, ${parseInt(e[2],16)}, ${parseInt(e[3],16)}`:"102, 187, 106"}drawRoundedRect(t,e,i,s,n,o){t.beginPath(),t.moveTo(e+o,i),t.lineTo(e+s-o,i),t.quadraticCurveTo(e+s,i,e+s,i+o),t.lineTo(e+s,i+n-o),t.quadraticCurveTo(e+s,i+n,e+s-o,i+n),t.lineTo(e+o,i+n),t.quadraticCurveTo(e,i+n,e,i+n-o),t.lineTo(e,i+o),t.quadraticCurveTo(e,i,e+o,i),t.closePath()}darkenColor(t,e){const i=parseInt(t.slice(1),16),s=Math.round(2.55*e);return`#${(1<<24|Math.max((i>>16)-s,0)<<16|Math.max((i>>8&255)-s,0)<<8|Math.max((255&i)-s,0)).toString(16).slice(1)}`}destroy(){this.deactivate()}activate(){this.bindTouchEvents()}deactivate(){const t=document.getElementById("gameCanvas");t?(this.touchStartHandler&&(t.removeEventListener("mousedown",this.touchStartHandler),t.removeEventListener("touchstart",this.touchStartHandler)),this.touchEndHandler&&(t.removeEventListener("mouseup",this.touchEndHandler),t.removeEventListener("touchend",this.touchEndHandler)),console.log("[BreathingExercise] Event listeners removed")):console.error("[BreathingExercise] Canvas not found for deactivation")}}class c extends o{constructor(){super(),this.isWxEnv="undefined"!=typeof wx,this.statusBarHeight=88,this.tips=[],this.currentTipIndex=0,this.isLoading=!1,this.errorMessage="",this.buttons=[],this.selectedButtonIndex=-1,this.theme={primary:"#4A69BD",primaryLight:"#6A89CC",secondary:"#FF9F43",accent:"#4DB6AC",background:"#F5F7FA",cardBg:"#FFFFFF",textPrimary:"#2C3E50",textSecondary:"#485460",textLight:"#747D8C",border:"#E8ECF1",success:"#26DE81",warning:"#FFB74D",error:"#FC5C65",loading:"#4A69BD",shadow:"rgba(74, 105, 189, 0.1)",gradientStart:"#6A89CC",gradientEnd:"#4A69BD"},this.backupTips=[{title:"æ¸è¿›å¼è‚Œè‚‰æ”¾æ¾æ³•",category:"æ”¾æ¾æŠ€å·§",content:"è¿™æ˜¯ä¸€ç§é€šè¿‡ç³»ç»Ÿæ€§åœ°ç´§å¼ å’Œæ”¾æ¾èº«ä½“ä¸åŒè‚Œè‚‰ç¾¤æ¥å‡è½»å‹åŠ›ä¸ç„¦è™‘çš„æŠ€å·§ã€‚é¦–å…ˆï¼Œæ‰¾ä¸€ä¸ªå®‰é™èˆ’é€‚çš„åœ°æ–¹åä¸‹æˆ–èººä¸‹ã€‚ä»è„šéƒ¨å¼€å§‹ï¼Œç”¨åŠ›ç»·ç´§è‚Œè‚‰5-7ç§’ï¼Œç„¶åå½»åº•æ”¾æ¾10-15ç§’ã€‚æ¥ç€ä¾æ¬¡å‘ä¸Šè¿›è¡Œï¼šå°è…¿ã€å¤§è…¿ã€è…¹éƒ¨ã€æ‰‹è‡‚ã€è‚©è†€ã€é¢éƒ¨ç­‰è‚Œç¾¤ã€‚æ•´ä¸ªè¿‡ç¨‹çº¦10-15åˆ†é’Ÿã€‚",icon:"ğŸŒ¿"},{title:"æ­£å¿µå‘¼å¸æ³•",category:"æ”¾æ¾æŠ€å·§",content:"ä¸“æ³¨äºå‘¼å¸çš„ç»ƒä¹ ï¼Œæ¯æ¬¡æ„Ÿè§‰åˆ†å¿ƒæ—¶ï¼Œæ¸©å’Œåœ°å°†æ³¨æ„åŠ›å¸¦å›å‘¼å¸ã€‚æ¯å¤©ç»ƒä¹ 5-10åˆ†é’Ÿï¼Œå¯ä»¥æœ‰æ•ˆé™ä½å‹åŠ›æ°´å¹³ï¼Œæé«˜ä¸“æ³¨åŠ›ã€‚",icon:"ğŸŒ¬ï¸"},{title:"æ„Ÿæ©æ—¥è®°",category:"ç§¯æå¿ƒç†",content:"æ¯å¤©å†™ä¸‹ä¸‰ä»¶ä½ æ„Ÿæ¿€çš„äº‹æƒ…ï¼Œæ— è®ºå¤§å°ã€‚è¿™ä¸ªä¹ æƒ¯èƒ½å¸®åŠ©ä½ é‡æ–°å…³æ³¨ç”Ÿæ´»ä¸­çš„ç§¯æé¢ï¼ŒåŸ¹å…»ä¹è§‚å¿ƒæ€ã€‚",icon:"ğŸ““"},{title:"ç¤¾äº¤è¿æ¥",category:"äººé™…å…³ç³»",content:"æ¯å‘¨è‡³å°‘ä¸ä¸€ä½æœ‹å‹æˆ–å®¶äººè¿›è¡Œæ·±åº¦äº¤æµï¼Œåˆ†äº«å½¼æ­¤çš„æ„Ÿå—å’Œç»å†ã€‚è‰¯å¥½çš„äººé™…å…³ç³»æ˜¯å¿ƒç†å¥åº·çš„é‡è¦æ”¯æŸ±ã€‚",icon:"ğŸ‘¥"},{title:"æ•°å­—æ’æ¯’",category:"ç”Ÿæ´»ä¹ æƒ¯",content:"æ¯å¤©è®¾å®šä¸€æ®µä¸ä½¿ç”¨ç”µå­è®¾å¤‡çš„æ—¶é—´ï¼Œæ¯”å¦‚ç¡å‰ä¸€å°æ—¶ã€‚è¿™æœ‰åŠ©äºæ”¹å–„ç¡çœ è´¨é‡ï¼Œå‡å°‘ä¿¡æ¯è¿‡è½½å¸¦æ¥çš„ç„¦è™‘ã€‚",icon:"ğŸ“µ"}],this.initButtons(),this.loadLocalTips()}loadLocalTips(){this.tips=[...this.backupTips],this.currentTipIndex=Math.floor(Math.random()*this.tips.length)}initButtons(){const t=(s-180)/2,e=n-120;this.buttons=[{id:"refresh",label:"æ¢ä¸€æ¡",icon:"ğŸ”„",x:t,y:e,width:180,height:60,bgColor:this.theme.primary,gradientStart:this.theme.gradientStart,gradientEnd:this.theme.gradientEnd,textColor:"#FFFFFF",shadowColor:"rgba(74, 105, 189, 0.3)"}]}bindTouchEvents(){this.isWxEnv&&(this.touchStartHandler=t=>{const e=t.touches[0];this.handleTouchStart(e.clientX,e.clientY)},this.touchEndHandler=t=>{const e=t.changedTouches[0];this.handleTouchEnd(e.clientX,e.clientY)},wx.onTouchStart&&wx.onTouchStart(this.touchStartHandler),wx.onTouchEnd&&wx.onTouchEnd(this.touchEndHandler))}handleTouchStart(t,e){this.selectedButtonIndex=-1;const i=Math.floor(.65*this.statusBarHeight);if(t>=30&&t<=90&&e>=i-20&&e<=i+20)this.selectedButtonIndex=-2;else{for(let i=0;i<this.buttons.length;i++){const s=this.buttons[i];if(t>=s.x&&t<=s.x+s.width&&e>=s.y&&e<=s.y+s.height){this.selectedButtonIndex=i;break}}if(this.errorMessage){const i=s/2-75,o=n/2+40;t>=i&&t<=i+150&&e>=o&&e<=o+45&&(this.selectedButtonIndex=-3)}}}handleTouchEnd(t,e){if(-2===this.selectedButtonIndex){const i=30,s=Math.floor(.65*this.statusBarHeight);t>=i&&t<=i+60&&e>=s-20&&e<=s+20&&this.emit("backToMenu")}else if(this.selectedButtonIndex>=0){const i=this.buttons[this.selectedButtonIndex];t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height&&"refresh"===i.id&&this.generateTips()}else if(-3===this.selectedButtonIndex){const i=s/2-75,o=n/2+40;t>=i&&t<=i+150&&e>=o&&e<=o+45&&this.generateTips()}this.selectedButtonIndex=-1}async generateTips(){var t,e,i;this.isLoading=!0,this.errorMessage="";try{const s=["æ”¾æ¾æŠ€å·§","ç§¯æå¿ƒç†","ç”Ÿæ´»ä¹ æƒ¯","èº«ä½“å¥åº·","äººé™…å…³ç³»","è‡ªæˆ‘æˆé•¿","è‡ªæˆ‘è®¤çŸ¥","å‹åŠ›ç®¡ç†"],n=[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªå¿ƒç†å¥åº·ä¸“å®¶ï¼Œä¸“æ³¨äºæä¾›å®ç”¨çš„å¿ƒç†å¥åº·å»ºè®®å’ŒæŠ€å·§ã€‚è¯·ç”Ÿæˆ1æ¡å¿ƒç†å¥åº·å°è´´å£«ï¼ŒåŒ…å«æ˜ç¡®çš„æ ‡é¢˜ã€åˆ†ç±»å’Œè¯¦ç»†å†…å®¹ã€‚åˆ†ç±»å¯ä»¥æ˜¯ï¼šæ”¾æ¾æŠ€å·§ã€ç§¯æå¿ƒç†ã€ç”Ÿæ´»ä¹ æƒ¯ã€èº«ä½“å¥åº·ã€äººé™…å…³ç³»ã€è‡ªæˆ‘æˆé•¿ã€è‡ªæˆ‘è®¤çŸ¥ã€å‹åŠ›ç®¡ç†ç­‰ã€‚è´´å£«çš„æ ¼å¼åº”è¯¥æ˜¯ï¼šæ ‡é¢˜|åˆ†ç±»|å†…å®¹ã€‚è¯·ç¡®ä¿å†…å®¹å®ç”¨ã€ç§‘å­¦ã€æ˜“äºç†è§£ï¼Œå†…å®¹é•¿åº¦åœ¨100-200å­—ä¹‹é—´ã€‚"},{role:"user",content:`è¯·ç”Ÿæˆä¸€æ¡å…³äº${s[Math.floor(Math.random()*s.length)]}çš„å¿ƒç†å¥åº·å°è´´å£«ï¼Œæ ¼å¼ä¸ºï¼šæ ‡é¢˜|åˆ†ç±»|å†…å®¹`}],o=await r.sendRequest(n,{timeout:1e4});if(o.error)throw new Error(o.error);const a=(null==(i=null==(e=null==(t=o.choices)?void 0:t[0])?void 0:e.message)?void 0:i.content)||"";if(!a)throw new Error("AIè¿”å›å†…å®¹ä¸ºç©º");this.parseAIContent(a)}catch(s){console.error("ç”Ÿæˆå¿ƒç†å°è´´å£«å¤±è´¥:",s),this.errorMessage=s.message||"ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•",this.loadLocalTips()}finally{this.isLoading=!1}}parseAIContent(t){const e=t.split("\n"),i=[];e.forEach(t=>{if(t=t.trim()){const e=t.split("|");e.length>=3&&i.push({title:e[0].trim(),category:e[1].trim(),content:e.slice(2).join("|").trim(),icon:this.getCategoryIcon(e[1].trim())})}}),i.length>0?(this.tips=i,this.currentTipIndex=0):this.loadLocalTips()}getCategoryIcon(t){return{"æ”¾æ¾æŠ€å·§":"ğŸŒ¿","ç§¯æå¿ƒç†":"ğŸ˜Š","ç”Ÿæ´»ä¹ æƒ¯":"ğŸ“","èº«ä½“å¥åº·":"ğŸ’ª","äººé™…å…³ç³»":"ğŸ‘¥","è‡ªæˆ‘æˆé•¿":"ğŸŒ±","è‡ªæˆ‘è®¤çŸ¥":"ğŸ§ ","å‹åŠ›ç®¡ç†":"âš–ï¸"}[t]||"ğŸ’¡"}render(t){this.renderBackground(t),this.renderStatusBar(t),this.isLoading?this.renderLoading(t):this.errorMessage?this.renderError(t):(this.renderTipCard(t),this.renderButtons(t))}renderLoading(t){const e=s/2,i=n/2;t.save(),t.fillStyle="rgba(255, 255, 255, 0.9)",this.drawRoundedRect(t,e-100,i-80,200,160,16),t.fill(),t.translate(e,i-30);const o=2*(Date.now()/1e3)%(2*Math.PI);t.rotate(o),t.strokeStyle=this.theme.loading,t.lineWidth=4,t.lineCap="round",t.beginPath(),t.arc(0,0,25,0,1.8*Math.PI),t.stroke(),t.restore(),t.fillStyle=this.theme.textPrimary,t.font='bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText("æ­£åœ¨ç”Ÿæˆå°è´´å£«...",e,i+20),t.fillStyle=this.theme.textLight,t.font='14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.fillText("æ­£åœ¨è°ƒç”¨AIç”Ÿæˆä¸ªæ€§åŒ–å»ºè®®",e,i+50)}renderError(t){const e=s/2,i=n/2-50;t.fillStyle="#FFFFFF",this.drawRoundedRect(t,e-140,i-70,280,200,16),t.fill(),t.fillStyle=this.theme.error,t.font='48px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText("âš ï¸",e,i-30),t.fillStyle=this.theme.textPrimary,t.font='bold 20px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.fillText("ç”Ÿæˆå¤±è´¥",e,i+10),t.fillStyle=this.theme.textSecondary,t.font='15px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.renderWrappedText(t,this.errorMessage,e-120,i+40,240,20);const o=s/2-75,r=i+90,a=t.createLinearGradient(o,r,o,r+48);a.addColorStop(0,this.theme.gradientStart),a.addColorStop(1,this.theme.gradientEnd),t.fillStyle=a,this.drawRoundedRect(t,o,r,150,48,24),t.fill(),t.shadowColor=this.theme.shadow,t.shadowBlur=12,t.shadowOffsetX=0,t.shadowOffsetY=4,t.fillStyle="#FFFFFF",t.font='bold 16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText("é‡è¯•",s/2,r+24),t.shadowBlur=0}renderBackground(t){const e=t.createLinearGradient(0,0,s,n);e.addColorStop(0,"#F5F7FA"),e.addColorStop(.5,"#FFFFFF"),e.addColorStop(1,"#E4EDF5"),t.fillStyle=e,t.fillRect(0,0,s,n),this.renderDecorations(t)}renderDecorations(t){t.save(),t.fillStyle="rgba(106, 137, 204, 0.03)",t.beginPath(),t.arc(.8*s,.2*n,60,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(.1*s,.7*n,80,0,2*Math.PI),t.fill(),t.strokeStyle="rgba(74, 105, 189, 0.05)",t.lineWidth=1;for(let e=0;e<5;e++){const i=n*(.1+.2*e);t.beginPath(),t.moveTo(0,i),t.lineTo(s,i),t.stroke()}t.restore()}renderStatusBar(t){const e=this.statusBarHeight,i=t.createLinearGradient(0,0,0,e);i.addColorStop(0,"#FFFFFF"),i.addColorStop(1,"#F8FAFD"),t.fillStyle=i,t.fillRect(0,0,s,e),t.fillStyle=this.theme.border,t.fillRect(0,e-1,s,1);const n=Math.floor(.65*e);t.fillStyle=this.theme.primary,t.font='28px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="left",t.textBaseline="middle",t.fillText("â†",30,n),t.fillStyle=this.theme.textPrimary,t.font='bold 22px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText("å¿ƒç†çŸ¥è¯†",s/2,n),t.fillStyle=this.theme.textLight,t.font='14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText("å¿ƒç†å¥åº·å°è´´å£«",s/2,n+28)}renderTipCard(t){if(0===this.tips.length)return t.fillStyle=this.theme.textSecondary,t.font='18px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",void t.fillText("æš‚æ— å°è´´å£«ï¼Œè¯·ç¨åå†è¯•",s/2,n/2);const e=this.tips[this.currentTipIndex],i=25,o=this.statusBarHeight+25,r=s-50,a=n-this.statusBarHeight-160;t.save(),t.shadowColor=this.theme.shadow,t.shadowBlur=20,t.shadowOffsetX=0,t.shadowOffsetY=8,t.fillStyle=this.theme.cardBg,this.drawRoundedRect(t,i,o,r,a,20),t.fill(),t.strokeStyle=this.theme.border,t.lineWidth=1,this.drawRoundedRect(t,i,o,r,a,20),t.stroke(),t.shadowBlur=0;const l=30;let h=o+l;t.save();const d=t.measureText(e.category).width+60;t.fillStyle="rgba(106, 137, 204, 0.1)",this.drawRoundedRect(t,55,h,d,34,17),t.fill(),t.fillStyle=this.theme.primary,t.font='15px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="left",t.textBaseline="middle",t.fillText(e.icon,67,h+17),t.fillText(e.category,97,h+17),t.restore(),h+=50,t.fillStyle=this.theme.textPrimary,t.font='bold 26px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="left",t.textBaseline="top",t.fillText(e.title,55,h),h+=40,t.strokeStyle=this.theme.border,t.lineWidth=1,t.beginPath(),t.moveTo(55,h),t.lineTo(i+r-l,h),t.stroke(),h+=25,t.fillStyle=this.theme.textSecondary,t.font='16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="left",t.textBaseline="top",this.renderWrappedText(t,e.content,55,h,r-60,24);const c=o+a-15;t.fillStyle=this.theme.textLight,t.font='13px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="right",t.fillText(`ğŸ’¡ å¿ƒç†å¥åº·å°è´´å£« ${this.currentTipIndex+1}/${this.tips.length}`,i+r-l,c),t.restore()}renderWrappedText(t,e,i,s,n,o){const r=e.split("");let a="",l=0;let h=s;for(let d=0;d<r.length;d++){const e=a+r[d];if(t.measureText(e).width>n||"\n"===r[d]){if(!(l<9)){let e=a;for(;t.measureText(e+"...").width>n&&e.length>0;)e=e.substring(0,e.length-1);return t.fillText(e+"...",i,h),h}t.fillText(a,i,h),a="\n"===r[d]?"":r[d],h+=o,l++}else a=e}return a&&t.fillText(a,i,h),h}renderButtons(t){0!==this.tips.length&&this.buttons.forEach((e,i)=>{const s=i===this.selectedButtonIndex;t.save(),t.shadowColor=s?"rgba(74, 105, 189, 0.4)":this.theme.shadow,t.shadowBlur=s?16:12,t.shadowOffsetX=0,t.shadowOffsetY=s?6:4;const n=t.createLinearGradient(e.x,e.y,e.x,e.y+e.height);n.addColorStop(0,e.gradientStart),n.addColorStop(1,e.gradientEnd),t.fillStyle=n,this.drawRoundedRect(t,e.x,e.y,e.width,e.height,30),t.fill(),t.shadowBlur=0,t.strokeStyle=s?"#FFFFFF":"rgba(255, 255, 255, 0.5)",t.lineWidth=s?3:2,this.drawRoundedRect(t,e.x,e.y,e.width,e.height,30),t.stroke(),t.fillStyle=e.textColor,t.font='24px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText(e.icon,e.x+35,e.y+e.height/2),t.fillStyle=e.textColor,t.font='bold 17px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText(e.label,e.x+e.width/2+10,e.y+e.height/2),s&&(t.fillStyle="rgba(255, 255, 255, 0.15)",this.drawRoundedRect(t,e.x,e.y,e.width,e.height,30),t.fill()),t.restore()})}drawRoundedRect(t,e,i,s,n,o){t.beginPath(),t.moveTo(e+o,i),t.lineTo(e+s-o,i),t.quadraticCurveTo(e+s,i,e+s,i+o),t.lineTo(e+s,i+n-o),t.quadraticCurveTo(e+s,i+n,e+s-o,i+n),t.lineTo(e+o,i+n),t.quadraticCurveTo(e,i+n,e,i+n-o),t.lineTo(e,i+o),t.quadraticCurveTo(e,i,e+o,i),t.closePath()}nextTip(){0!==this.tips.length&&(this.currentTipIndex=(this.currentTipIndex+1)%this.tips.length)}prevTip(){0!==this.tips.length&&(this.currentTipIndex=(this.currentTipIndex-1+this.tips.length)%this.tips.length)}destroy(){this.deactivate()}activate(){this.bindTouchEvents()}deactivate(){const t=document.getElementById("gameCanvas");t?(this.touchStartHandler&&(t.removeEventListener("mousedown",this.touchStartHandler),t.removeEventListener("touchstart",this.touchStartHandler)),this.touchEndHandler&&(t.removeEventListener("mouseup",this.touchEndHandler),t.removeEventListener("touchend",this.touchEndHandler)),console.log("[MentalTips] Event listeners removed")):console.error("[MentalTips] Canvas not found for deactivation")}}class u extends o{constructor(){super(),this.isWxEnv="undefined"!=typeof wx,this.statusBarHeight=88,this.content="",this.isContentFocused=!1,this.isSaving=!1,this.saveSuccess=!1,this.buttons=[],this.selectedButtonIndex=-1,this.initButtons()}initButtons(){const t=120,e=(s-240-20)/2,i=n-100;this.buttons=[{id:"publish",label:"ä¿ç•™",x:e,y:i,width:t,height:50,bgColor:"#4CAF50",textColor:"#FFFFFF"},{id:"clear",label:"æ¸…ç©º",x:e+t+20,y:i,width:t,height:50,bgColor:"#F44336",textColor:"#FFFFFF"}]}bindTouchEvents(){const t=document.getElementById("gameCanvas");t?(this.touchStartHandler=t=>{t.preventDefault();const e=t.clientX||t.touches&&t.touches[0].clientX,i=t.clientY||t.touches&&t.touches[0].clientY;void 0!==e&&void 0!==i&&(console.log("[DiaryBook] Start event:",{x:e,y:i}),this.handleTouchStart(e,i))},this.touchEndHandler=t=>{t.preventDefault();const e=t.clientX||t.changedTouches&&t.changedTouches[0].clientX,i=t.clientY||t.changedTouches&&t.changedTouches[0].clientY;void 0!==e&&void 0!==i&&(console.log("[DiaryBook] End event:",{x:e,y:i}),this.handleTouchEnd(e,i))},t.addEventListener("mousedown",this.touchStartHandler),t.addEventListener("touchstart",this.touchStartHandler),t.addEventListener("mouseup",this.touchEndHandler),t.addEventListener("touchend",this.touchEndHandler),console.log("[DiaryBook] Event listeners bound to canvas")):console.error("[DiaryBook] Canvas not found")}handleTouchStart(t,e){this.selectedButtonIndex=-1;for(let s=0;s<this.buttons.length;s++){const i=this.buttons[s];if(t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height)return void(this.selectedButtonIndex=s)}if(t>=10&&t<=40&&e>=30&&e<=60)return;const i=this.statusBarHeight+30;t>=20&&t<=20+(s-40)&&e>=i&&e<=i+350?(this.isContentFocused=!0,this.showKeyboard(this.content)):(this.isContentFocused=!1,this.hideKeyboard())}handleTouchEnd(t,e){if(this.selectedButtonIndex>=0){const i=this.buttons[this.selectedButtonIndex];return t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height&&("publish"===i.id?this.saveDiary():"clear"===i.id&&this.clearDiary()),void(this.selectedButtonIndex=-1)}const i=this.statusBarHeight+30;t>=20&&t<=20+(s-40)&&e>=i&&e<=i+350||t>=10&&t<=40&&e>=30&&e<=60&&this.emit("backToMenu"),this.selectedButtonIndex=-1}showKeyboard(t){this.isWxEnv&&wx.showKeyboard&&(wx.showKeyboard({defaultValue:t||"",maxLength:500,multiple:!0,confirmHold:!1,confirmType:"done",confirmText:"å®Œæˆ"}),wx.onKeyboardInput&&wx.onKeyboardInput(t=>{this.content=t.value}),wx.onKeyboardComplete&&wx.onKeyboardComplete(()=>{this.isContentFocused=!1}))}hideKeyboard(){this.isWxEnv&&wx.hideKeyboard&&wx.hideKeyboard()}saveDiary(){this.content.trim()&&(this.isSaving=!0,setTimeout(()=>{this.isSaving=!1,this.saveSuccess=!0,this.content="",setTimeout(()=>{this.saveSuccess=!1},2e3)},1e3))}clearDiary(){this.content="",this.isContentFocused=!1,this.saveSuccess=!1,this.hideKeyboard()}render(t){this.renderBackground(t),this.renderStatusBar(t),this.renderDate(t),this.renderContentInput(t),this.isSaving?this.renderSaving(t):this.saveSuccess?this.renderSaveSuccess(t):this.renderButtons(t)}renderBackground(t){t.fillStyle="#FFFFFF",t.fillRect(0,0,s,n)}renderStatusBar(t){const e=this.statusBarHeight;t.fillStyle="#F7F7F7",t.fillRect(0,0,s,e),t.fillStyle="#DADADA",t.fillRect(0,e-1,s,1);const i=Math.floor(.35*e);t.save(),t.strokeStyle="#111111",t.lineWidth=2,t.beginPath(),t.moveTo(30,i),t.lineTo(10,i+10),t.lineTo(30,i+20),t.stroke(),t.restore(),t.fillStyle="#111111",t.font="20px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("æ—¥è®°ä¹¦",s/2,Math.floor(.65*e))}renderDate(t){const e=(new Date).toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric",weekday:"long"});t.fillStyle="#666666",t.font="16px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(e,s/2,this.statusBarHeight+15)}renderContentInput(t){const e=this.statusBarHeight+30,i=s-40;if(t.save(),t.fillStyle="#FFFFFF",this.drawRoundedRect(t,20,e,i,350,16),t.fill(),t.shadowColor="rgba(0, 0, 0, 0.1)",t.shadowBlur=10,t.shadowOffsetY=4,t.strokeStyle=this.isContentFocused?"#4CAF50":"#E0E0E0",t.lineWidth=2,t.stroke(),t.fillStyle="#999999",t.font="18px Arial",t.textAlign="left",t.textBaseline="top",this.content.trim()){t.fillStyle="#333333";this.wrapText(t,this.content,i-30).forEach((i,s)=>{t.fillText(i,35,e+15+25*s)})}else t.fillText("ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆäº‹...",35,e+15);t.restore()}renderSaving(t){t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,s,n);const e=(s-200)/2,i=(n-100)/2;t.fillStyle="#FFFFFF",this.drawRoundedRect(t,e,i,200,100,10),t.fill(),t.fillStyle="#4CAF50",t.font="18px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("ä¿ç•™ä¸­...",s/2,n/2)}renderSaveSuccess(t){t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(0,0,s,n);const e=(s-200)/2,i=(n-100)/2;t.fillStyle="#FFFFFF",this.drawRoundedRect(t,e,i,200,100,10),t.fill(),t.fillStyle="#4CAF50",t.font="18px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("ä¿ç•™æˆåŠŸï¼",s/2,n/2)}renderButtons(t){this.buttons.forEach((e,i)=>{const s=i===this.selectedButtonIndex;t.save(),t.fillStyle=s?this.darkenColor(e.bgColor,20):"#FFFFFF",this.drawRoundedRect(t,e.x,e.y,e.width,e.height,16),t.fill(),t.shadowColor="rgba(0, 0, 0, 0.05)",t.shadowBlur=8,t.shadowOffsetY=2,t.strokeStyle=e.bgColor,t.lineWidth=2,t.stroke(),t.fillStyle=e.bgColor,t.font="bold 16px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText(e.label,e.x+e.width/2,e.y+e.height/2),t.restore()})}wrapText(t,e,i){const s=e.split(" "),n=[];let o="";return s.forEach(e=>{const s=o+e+" ";t.measureText(s).width>i&&""!==o?(n.push(o),o=e+" "):o=s}),""!==o&&n.push(o),n}drawRoundedRect(t,e,i,s,n,o){t.beginPath(),t.moveTo(e+o,i),t.lineTo(e+s-o,i),t.quadraticCurveTo(e+s,i,e+s,i+o),t.lineTo(e+s,i+n-o),t.quadraticCurveTo(e+s,i+n,e+s-o,i+n),t.lineTo(e+o,i+n),t.quadraticCurveTo(e,i+n,e,i+n-o),t.lineTo(e,i+o),t.quadraticCurveTo(e,i,e+o,i),t.closePath()}darkenColor(t,e){const i=parseInt(t.slice(1),16),s=Math.round(2.55*e);return`#${(1<<24|Math.max((i>>16)-s,0)<<16|Math.max((i>>8&255)-s,0)<<8|Math.max((255&i)-s,0)).toString(16).slice(1)}`}destroy(){this.deactivate()}activate(){this.bindTouchEvents()}deactivate(){const t=document.getElementById("gameCanvas");if(!t)return void console.error("[DiaryBook] Canvas not found for deactivation");this.touchStartHandler&&(t.removeEventListener("mousedown",this.touchStartHandler),t.removeEventListener("touchstart",this.touchStartHandler)),this.touchEndHandler&&(t.removeEventListener("mouseup",this.touchEndHandler),t.removeEventListener("touchend",this.touchEndHandler));const e=document.getElementById("keyboard-input");e&&e.blur(),console.log("[DiaryBook] Event listeners removed")}}class g extends o{constructor(){super(),this.isWxEnv="undefined"!=typeof wx,this.statusBarHeight=88,this.currentQuestionIndex=0,this.answers=[],this.theme={primary:"#5B8BF7",primaryLight:"#E8EEFF",background:"#F8FAFF",cardBg:"#FFFFFF",textPrimary:"#2D3748",textSecondary:"#718096",border:"#E2E8F0",success:"#48BB78",warning:"#ED8936",error:"#F56565",good:"#4CAF50",medium:"#FF9800",poor:"#F44336"},this.questions=[{id:1,text:"æ‚¨æœ€è¿‘ä¸€å‘¨çš„å¿ƒæƒ…å¦‚ä½•ï¼Ÿ",options:[{text:"éå¸¸æ„‰å¿«",score:5,emoji:"ğŸ˜Š"},{text:"æ¯”è¾ƒæ„‰å¿«",score:4,emoji:"ğŸ™‚"},{text:"ä¸€èˆ¬",score:3,emoji:"ğŸ˜"},{text:"æ¯”è¾ƒä½è½",score:2,emoji:"ğŸ˜”"},{text:"éå¸¸ä½è½",score:1,emoji:"ğŸ˜¢"}]},{id:2,text:"æ‚¨æœ€è¿‘ä¸€å‘¨çš„ç¡çœ è´¨é‡å¦‚ä½•ï¼Ÿ",options:[{text:"éå¸¸å¥½",score:5,emoji:"ğŸ˜´"},{text:"æ¯”è¾ƒå¥½",score:4,emoji:"ğŸ˜Œ"},{text:"ä¸€èˆ¬",score:3,emoji:"ğŸ˜ª"},{text:"æ¯”è¾ƒå·®",score:2,emoji:"ğŸ˜«"},{text:"éå¸¸å·®",score:1,emoji:"ğŸ¥±"}]},{id:3,text:"æ‚¨æœ€è¿‘ä¸€å‘¨çš„ç²¾åŠ›çŠ¶æ€å¦‚ä½•ï¼Ÿ",options:[{text:"éå¸¸å……æ²›",score:5,emoji:"ğŸ’ª"},{text:"æ¯”è¾ƒå……æ²›",score:4,emoji:"ğŸ‘"},{text:"ä¸€èˆ¬",score:3,emoji:"ğŸ¤”"},{text:"æ¯”è¾ƒç–²æƒ«",score:2,emoji:"ğŸ˜´"},{text:"éå¸¸ç–²æƒ«",score:1,emoji:"ğŸ˜«"}]},{id:4,text:"æ‚¨æœ€è¿‘ä¸€å‘¨çš„å‹åŠ›æ°´å¹³å¦‚ä½•ï¼Ÿ",options:[{text:"éå¸¸ä½",score:5,emoji:"ğŸ˜Œ"},{text:"æ¯”è¾ƒä½",score:4,emoji:"ğŸ™‚"},{text:"ä¸€èˆ¬",score:3,emoji:"ğŸ˜"},{text:"æ¯”è¾ƒé«˜",score:2,emoji:"ğŸ˜°"},{text:"éå¸¸é«˜",score:1,emoji:"ğŸ˜«"}]},{id:5,text:"æ‚¨æœ€è¿‘ä¸€å‘¨çš„ç¤¾äº¤æ´»åŠ¨é¢‘ç‡å¦‚ä½•ï¼Ÿ",options:[{text:"éå¸¸é¢‘ç¹",score:5,emoji:"ğŸ‘¥"},{text:"æ¯”è¾ƒé¢‘ç¹",score:4,emoji:"ğŸ‘­"},{text:"ä¸€èˆ¬",score:3,emoji:"ğŸ™‹"},{text:"æ¯”è¾ƒå°‘",score:2,emoji:"ğŸ§"},{text:"éå¸¸å°‘",score:1,emoji:"ğŸ "}]}],this.selectedOptionIndex=-1}bindTouchEvents(){const t=document.getElementById("gameCanvas");t?(this.touchStartHandler=t=>{t.preventDefault();const e=t.clientX||t.touches&&t.touches[0].clientX,i=t.clientY||t.touches&&t.touches[0].clientY;void 0!==e&&void 0!==i&&(console.log("[MoodAssessment] Start event:",{x:e,y:i}),this.handleTouchStart(e,i))},this.touchEndHandler=t=>{t.preventDefault();const e=t.clientX||t.changedTouches&&t.changedTouches[0].clientX,i=t.clientY||t.changedTouches&&t.changedTouches[0].clientY;void 0!==e&&void 0!==i&&(console.log("[MoodAssessment] End event:",{x:e,y:i}),this.handleTouchEnd(e,i))},t.addEventListener("mousedown",this.touchStartHandler),t.addEventListener("touchstart",this.touchStartHandler),t.addEventListener("mouseup",this.touchEndHandler),t.addEventListener("touchend",this.touchEndHandler),console.log("[MoodAssessment] Event listeners bound to canvas")):console.error("[MoodAssessment] Canvas not found")}handleTouchStart(t,e){const i=Math.floor(.65*this.statusBarHeight);if(t>=30&&t<=90&&e>=i-20&&e<=i+20)this.selectedOptionIndex=-3;else if(this.currentQuestionIndex<this.questions.length){const i=this.questions[this.currentQuestionIndex],n=70,o=15,r=this.statusBarHeight+200;for(let a=0;a<i.options.length;a++){const i=r+a*(n+o);if(t>=30&&t<=s-30&&e>=i&&e<=i+n){this.selectedOptionIndex=a;break}}}else{const i=s/2-100,n=this.statusBarHeight+660;t>=i&&t<=i+200&&e>=n&&e<=n+50&&(this.selectedOptionIndex=-2)}}handleTouchEnd(t,e){if(-3===this.selectedOptionIndex){const i=30,s=Math.floor(.65*this.statusBarHeight);t>=i&&t<=i+60&&e>=s-20&&e<=s+20&&this.emit("backToMenu")}else if(-2===this.selectedOptionIndex){const i=s/2-100,n=this.statusBarHeight+660;t>=i&&t<=i+200&&e>=n&&e<=n+50&&this.emit("backToMenu")}else if(this.selectedOptionIndex>=0&&this.currentQuestionIndex<this.questions.length){const i=this.questions[this.currentQuestionIndex],n=70,o=15,r=this.statusBarHeight+200;for(let a=0;a<i.options.length;a++){const l=r+a*(n+o);if(t>=30&&t<=s-30&&e>=l&&e<=l+n){this.answers.push({questionId:i.id,selectedOption:a,score:i.options[a].score}),this.currentQuestionIndex++,this.selectedOptionIndex=-1;break}}}}calculateResult(){const t=this.answers.reduce((t,e)=>t+e.score,0)/this.questions.length;return t>=4?{level:"è‰¯å¥½",emoji:"ğŸ˜Š",message:"æ‚¨çš„æƒ…ç»ªçŠ¶æ€è‰¯å¥½ï¼Œç»§ç»­ä¿æŒç§¯æçš„ç”Ÿæ´»æ€åº¦ï¼",suggestion:"å»ºè®®æ‚¨ç»§ç»­ä¿æŒè§„å¾‹çš„ä½œæ¯å’Œé€‚é‡çš„è¿åŠ¨ï¼Œå¤šä¸æœ‹å‹å®¶äººäº¤æµï¼Œä¿æŒä¹è§‚çš„å¿ƒæ€ã€‚",color:this.theme.good,gradientStart:"#E8F5E9",gradientEnd:"#F1F8E9"}:t>=3?{level:"ä¸€èˆ¬",emoji:"ğŸ˜",message:"æ‚¨çš„æƒ…ç»ªçŠ¶æ€ä¸€èˆ¬ï¼Œéœ€è¦é€‚å½“å…³æ³¨å’Œè°ƒæ•´ã€‚",suggestion:"å»ºè®®æ‚¨å°è¯•ä¸€äº›æ”¾æ¾æŠ€å·§ï¼Œå¦‚æ·±å‘¼å¸ã€å†¥æƒ³æˆ–ç‘œä¼½ï¼Œä¿æŒå……è¶³çš„ç¡çœ ï¼Œå¿…è¦æ—¶ä¸å¿ƒç†å’¨è¯¢å¸ˆäº¤æµã€‚",color:this.theme.medium,gradientStart:"#FFF3E0",gradientEnd:"#FFECB3"}:{level:"éœ€è¦å…³æ³¨",emoji:"ğŸ˜”",message:"æ‚¨çš„æƒ…ç»ªçŠ¶æ€éœ€è¦ç‰¹åˆ«å…³æ³¨ï¼Œå»ºè®®å¯»æ±‚ä¸“ä¸šå¸®åŠ©ã€‚",suggestion:"å»ºè®®æ‚¨å°½å¿«ä¸ä¸“ä¸šå¿ƒç†å’¨è¯¢å¸ˆè”ç³»ï¼ŒåŒæ—¶å°è¯•ä¸€äº›æƒ…ç»ªç®¡ç†æŠ€å·§ï¼Œå¦‚å†™æ—¥è®°ã€å¬éŸ³ä¹ã€è¿›è¡Œé€‚åº¦çš„è¿åŠ¨ç­‰ã€‚",color:this.theme.poor,gradientStart:"#FFEBEE",gradientEnd:"#FFCDD2"}}render(t){this.renderBackground(t),this.renderStatusBar(t),this.currentQuestionIndex<this.questions.length?this.renderQuestion(t):this.renderResult(t)}renderBackground(t){const e=t.createLinearGradient(0,0,s,n);e.addColorStop(0,"#F8FAFF"),e.addColorStop(.5,"#FFFFFF"),e.addColorStop(1,"#F0F4FF"),t.fillStyle=e,t.fillRect(0,0,s,n)}renderStatusBar(t){const e=this.statusBarHeight,i=t.createLinearGradient(0,0,0,e);i.addColorStop(0,"#FFFFFF"),i.addColorStop(1,"#F8FAFF"),t.fillStyle=i,t.fillRect(0,0,s,e),t.fillStyle="rgba(0, 0, 0, 0.05)",t.fillRect(0,e-1,s,1);const n=Math.floor(.65*e);t.fillStyle=this.theme.primary,t.font='28px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="left",t.textBaseline="middle",t.fillText("â†",30,n),t.fillStyle=this.theme.textPrimary,t.font='bold 22px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText("æƒ…ç»ªçŠ¶æ€è¯„ä¼°",s/2,n)}renderQuestion(t){const e=this.questions[this.currentQuestionIndex],i=(this.currentQuestionIndex+1)/this.questions.length;t.fillStyle=this.theme.border,this.drawRoundedRect(t,30,this.statusBarHeight+80,s-60,10,5),t.fill(),t.fillStyle=this.theme.primary,this.drawRoundedRect(t,30,this.statusBarHeight+80,(s-60)*i,10,5),t.fill(),t.fillStyle=this.theme.textSecondary,t.font='14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText(`é—®é¢˜ ${this.currentQuestionIndex+1} / ${this.questions.length}`,s/2,this.statusBarHeight+105);const n=e.text,o=this.statusBarHeight+130,r=s-80;t.save(),t.fillStyle="#FFFFFF",this.drawRoundedRect(t,30,this.statusBarHeight+120,s-60,80,12),t.fill(),t.shadowColor="rgba(0, 0, 0, 0.05)",t.shadowBlur=8,t.shadowOffsetX=0,t.shadowOffsetY=3,t.strokeStyle=this.theme.border,t.lineWidth=1,this.drawRoundedRect(t,30,this.statusBarHeight+120,s-60,80,12),t.stroke(),t.fillStyle=this.theme.primary,t.font='24px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText("â“",50,this.statusBarHeight+160),t.restore(),t.fillStyle=this.theme.textPrimary,t.font='bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="left",t.textBaseline="top",this.renderWrappedTextFixed(t,n,80,o,r-40,28);const a=70,l=this.statusBarHeight+210;e.options.forEach((e,i)=>{const n=l+82*i;t.save(),this.selectedOptionIndex===i?t.fillStyle=this.theme.primaryLight:t.fillStyle="#FFFFFF",this.drawRoundedRect(t,30,n,s-60,a,14),t.fill(),t.shadowColor="rgba(0, 0, 0, 0.08)",t.shadowBlur=10,t.shadowOffsetX=0,t.shadowOffsetY=3,t.strokeStyle=this.selectedOptionIndex===i?this.theme.primary:this.theme.border,t.lineWidth=this.selectedOptionIndex===i?2:1,this.drawRoundedRect(t,30,n,s-60,a,14),t.stroke(),t.fillStyle=this.theme.textPrimary,t.font='24px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="left",t.textBaseline="middle",t.fillText(e.emoji,50,n+35),t.fillStyle=this.theme.textPrimary,t.font='16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="left",t.textBaseline="middle";t.measureText(e.text).width>s-120&&(t.font='14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'),t.fillText(e.text,90,n+35),this.selectedOptionIndex===i&&(t.fillStyle=this.theme.primary,t.beginPath(),t.arc(s-50,n+35,10,0,2*Math.PI),t.fill(),t.fillStyle="#FFFFFF",t.font='14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText("âœ“",s-50,n+35)),t.restore()})}renderResult(t){const e=this.calculateResult();t.save();const i=t.createLinearGradient(30,this.statusBarHeight+120,30,this.statusBarHeight+580);i.addColorStop(0,e.gradientStart),i.addColorStop(1,e.gradientEnd),t.fillStyle=i,this.drawRoundedRect(t,30,this.statusBarHeight+120,s-60,460,20),t.fill(),t.shadowColor="rgba(0, 0, 0, 0.12)",t.shadowBlur=16,t.shadowOffsetX=0,t.shadowOffsetY=6,t.strokeStyle=this.theme.border,t.lineWidth=1,this.drawRoundedRect(t,30,this.statusBarHeight+120,s-60,460,20),t.stroke(),t.fillStyle=e.color,t.font='48px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText(e.emoji,s/2,this.statusBarHeight+180),t.fillStyle=this.theme.textPrimary,t.font='bold 24px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="top",t.fillText("è¯„ä¼°å®Œæˆ",s/2,this.statusBarHeight+230),t.fillStyle=e.color,t.font='bold 28px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="top",t.fillText(e.level,s/2,this.statusBarHeight+270),t.fillStyle=this.theme.textSecondary,t.font='16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="top";const n=this.renderWrappedTextFixed(t,e.message,50,this.statusBarHeight+320,s-100,20);t.fillStyle=this.theme.textPrimary,t.font='bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="left",t.textBaseline="top",t.fillText("ğŸ’¡ å»ºè®®",50,n+25),t.fillStyle=this.theme.textSecondary,t.font='15px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="left",t.textBaseline="top",this.renderWrappedTextFixed(t,e.suggestion,50,n+55,s-100,18),t.restore();const o=s/2-100,r=this.statusBarHeight+660,a=t.createLinearGradient(o,r,o,r+50);a.addColorStop(0,this.theme.primary),a.addColorStop(1,"#3A6FEF"),t.fillStyle=a,this.drawRoundedRect(t,o,r,200,50,25),t.fill(),t.shadowColor="rgba(91, 139, 247, 0.25)",t.shadowBlur=10,t.shadowOffsetX=0,t.shadowOffsetY=4,t.fillStyle="#FFFFFF",t.font='bold 17px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',t.textAlign="center",t.textBaseline="middle",t.fillText("è¿”å›ä¸»èœå•",o+100,r+25)}renderWrappedTextFixed(t,e,i,s,n,o){const r=e.split("");let a="",l=0;let h=s;for(let d=0;d<r.length;d++){const e=a+r[d];if(t.measureText(e).width>n||"\n"===r[d]){if(!(l<5)){let e=a;for(;t.measureText(e+"...").width>n&&e.length>0;)e=e.substring(0,e.length-1);return t.fillText(e+"...",i,h),h}t.fillText(a,i,h),a="\n"===r[d]?"":r[d],h+=o,l++}else a=e}return a&&t.fillText(a,i,h),h}renderWrappedText(t,e,i,s,n,o){const r=e.split("");let a="",l=0;let h=s;for(let d=0;d<r.length;d++){const e=a+r[d];if(t.measureText(e).width>n&&d>0){if(!(l<3))return a=a.substring(0,a.length-3)+"...",t.fillText(a,i,h),h;t.fillText(a,i,h),a=r[d],h+=o,l++}else a=e}return t.fillText(a,i,h),h}drawRoundedRect(t,e,i,s,n,o){t.beginPath(),t.moveTo(e+o,i),t.lineTo(e+s-o,i),t.quadraticCurveTo(e+s,i,e+s,i+o),t.lineTo(e+s,i+n-o),t.quadraticCurveTo(e+s,i+n,e+s-o,i+n),t.lineTo(e+o,i+n),t.quadraticCurveTo(e,i+n,e,i+n-o),t.lineTo(e,i+o),t.quadraticCurveTo(e,i,e+o,i),t.closePath()}destroy(){this.deactivate()}activate(){this.bindTouchEvents()}deactivate(){const t=document.getElementById("gameCanvas");t?(this.touchStartHandler&&(t.removeEventListener("mousedown",this.touchStartHandler),t.removeEventListener("touchstart",this.touchStartHandler)),this.touchEndHandler&&(t.removeEventListener("mouseup",this.touchEndHandler),t.removeEventListener("touchend",this.touchEndHandler)),console.log("[MoodAssessment] Event listeners removed")):console.error("[MoodAssessment] Canvas not found for deactivation")}}const f=canvas.getContext("2d");const m=document.getElementById("gameCanvas");m?(m.addEventListener("click",t=>{console.log("Canvas clicked!",{clientX:t.clientX,clientY:t.clientY,offsetX:t.offsetX,offsetY:t.offsetY})}),m.addEventListener("mousedown",t=>{console.log("Canvas mousedown!",{clientX:t.clientX,clientY:t.clientY})}),console.log("Global canvas event listeners added")):console.error("Canvas not found for global listeners"),new class{constructor(){e(this,"aniId",0),e(this,"currentScreen","menu"),e(this,"previousScreen",null),e(this,"mainMenu",null),e(this,"chat",null),e(this,"breathing",null),e(this,"tips",null),e(this,"diary",null),this.initScreens(),this.start()}initScreens(){this.mainMenu=new h,this.chat=new l,this.breathing=new d,this.tips=new c,this.diary=new u,this.moodAssessment=new g,this.mainMenu.on("buttonClick",t=>{this.handleMenuButtonClick(t)}),this.mainMenu.on("startAssessment",()=>{this.switchToScreen("mood-assessment")}),this.chat.on("backToMenu",()=>{this.switchToScreen("menu")}),this.breathing.on("backToMenu",()=>{this.switchToScreen("menu")}),this.tips.on("backToMenu",()=>{this.switchToScreen("menu")}),this.diary.on("backToMenu",()=>{this.switchToScreen("menu")}),this.moodAssessment.on("backToMenu",()=>{this.switchToScreen("menu")}),this.mainMenu.activate()}handleMenuButtonClick(t){"chat"===t?this.switchToScreen("chat"):"breathing"===t?this.switchToScreen("breathing"):"tips"===t?this.switchToScreen("tips"):"diary"===t?this.switchToScreen("diary"):"settings"===t&&console.log("Settings clicked")}switchToScreen(t){if(this.previousScreen=this.currentScreen,this.currentScreen=t,wx&&wx.hideKeyboard&&wx.hideKeyboard(),this.previousScreen)switch(this.previousScreen){case"menu":this.mainMenu&&this.mainMenu.deactivate&&this.mainMenu.deactivate();break;case"breathing":this.breathing&&this.breathing.deactivate&&this.breathing.deactivate();break;case"tips":this.tips&&this.tips.deactivate&&this.tips.deactivate();break;case"diary":this.diary&&this.diary.deactivate&&this.diary.deactivate();break;case"mood-assessment":this.moodAssessment&&this.moodAssessment.deactivate&&this.moodAssessment.deactivate()}switch(t){case"menu":this.mainMenu&&this.mainMenu.activate&&this.mainMenu.activate();break;case"breathing":this.breathing&&this.breathing.activate&&this.breathing.activate();break;case"tips":this.tips&&this.tips.activate&&this.tips.activate();break;case"diary":this.diary&&this.diary.activate&&this.diary.activate();break;case"mood-assessment":this.moodAssessment&&this.moodAssessment.activate&&this.moodAssessment.activate()}}start(){cancelAnimationFrame(this.aniId),this.aniId=requestAnimationFrame(this.loop.bind(this))}render(){f.clearRect(0,0,canvas.width,canvas.height),"menu"===this.currentScreen?this.mainMenu.render(f):"chat"===this.currentScreen?this.chat.render(f):"breathing"===this.currentScreen?this.breathing.render(f):"tips"===this.currentScreen?this.tips.render(f):"diary"===this.currentScreen?this.diary.render(f):"mood-assessment"===this.currentScreen&&this.moodAssessment.render(f)}loop(){this.render(),this.aniId=requestAnimationFrame(this.loop.bind(this))}};
//# sourceMappingURL=index-BGBQjLbq.js.map
